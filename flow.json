[{"id":"9728e5d5.763308","type":"tab","label":"Webpage","disabled":false,"info":""},{"id":"1e3bcfcf.ac722","type":"tab","label":"Pager Dynamic Display","disabled":false,"info":""},{"id":"11ba16cf.809619","type":"tab","label":"Log Display Full","disabled":false,"info":""},{"id":"599bf1f1.c3be9","type":"tab","label":"Log Display Daily","disabled":false,"info":""},{"id":"d686dfef.717a1","type":"tab","label":"Export","disabled":false,"info":""},{"id":"58f779e8.0e4218","type":"tab","label":"DB Utilities","disabled":false,"info":""},{"id":"5461daa4.49fb24","type":"serial-port","z":"","serialport":"/dev/ttyUSB0","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"50","bin":"false","out":"interbyte","addchar":false,"responsetimeout":""},{"id":"8ad92631.0da208","type":"websocket-listener","z":"","path":"/ws/data","wholemsg":"true"},{"id":"33804e00.060d32","type":"sqlitedb","z":"","db":"/home/Ingenso/CaptureCall.db","mode":"RWC"},{"id":"60d07179.968bc","type":"json-db-collection","z":"","name":"","collection":"settings","save":true},{"id":"5cdd612c.78168","type":"websocket-listener","z":"","path":"/ws/export","wholemsg":"false"},{"id":"e0f20fd0.b6362","type":"websocket-listener","z":"","path":"/ws/sender","wholemsg":"false"},{"id":"d471fcd2.f0968","type":"websocket-listener","z":"","path":"/ws/receive","wholemsg":"true"},{"id":"87b7d713.a17d18","type":"websocket-listener","z":"","path":"/ws/send","wholemsg":"false"},{"id":"48f558f0.c51958","type":"websocket-listener","z":"","path":"/ws/data1","wholemsg":"true"},{"id":"5a62e1c4.8d678","type":"e-mail","z":"d686dfef.717a1","server":"smtp.gmail.com","port":"465","secure":true,"name":"","dname":"CaptureCall System","x":1340,"y":380,"wires":[]},{"id":"f206d4bc.401878","type":"csv","z":"d686dfef.717a1","name":"","sep":",","hdrin":"","hdrout":true,"multi":"one","ret":"\\n","temp":"Index, Call Point, Message, ReceivedTime, Status, StatusTime, ExportedTime, Recipient, System ID","skip":"0","x":950,"y":400,"wires":[["d9415621.fb1608","ec68fae6.db48b8"]]},{"id":"20556d10.20ad12","type":"template","z":"d686dfef.717a1","name":"Export All","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"SELECT \n`index` AS 'Index',\n`sender` AS 'Call Point',\n`content` AS 'Message',\n`rxTime`,\n`status` AS 'Status',\n`statusTime`,\n`exported`,\n`pagerNumber` AS 'Recipient',\n`sysID` AS 'System ID'\nFROM `log`\nORDER BY  `rxTime` DESC;","output":"str","x":400,"y":440,"wires":[["dc12e674.582e68"]]},{"id":"d9415621.fb1608","type":"change","z":"d686dfef.717a1","name":"Setup mail content","rules":[{"t":"set","p":"attachments","pt":"msg","to":"[{\t    \"filename\": 'log.csv', \t    \"content\": $$.payload\t}]","tot":"jsonata"},{"t":"set","p":"topic","pt":"msg","to":"CaptureCall System Log","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"Attached is the requested information from your CaptureCall system.","tot":"str"},{"t":"set","p":"to","pt":"msg","to":"to","tot":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":1130,"y":400,"wires":[["5a62e1c4.8d678"]]},{"id":"51ac9ab9.85d7a4","type":"http response","z":"d686dfef.717a1","name":"","statusCode":"","headers":{},"x":650,"y":80,"wires":[]},{"id":"c7edd2a6.a425a","type":"http in","z":"d686dfef.717a1","name":"","url":"/export","method":"get","upload":false,"swaggerDoc":"","x":90,"y":80,"wires":[["c037f395.0797a"]]},{"id":"46eeed9e.01c534","type":"comment","z":"d686dfef.717a1","name":"Build Webpage","info":"","x":100,"y":40,"wires":[]},{"id":"8d1c3c15.f0953","type":"link out","z":"d686dfef.717a1","name":"","links":["4e306403.b3c8ac","e9a02996.2dcce8","2c79b941.11ba86","8ab05f94.8a1b","31885960.18a2a6"],"x":615,"y":40,"wires":[]},{"id":"ec28d0d8.00efb","type":"template","z":"d686dfef.717a1","name":"HTML","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<!DOCTYPE html>\n<html>\n<head>\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n<style>\n{{{global.css}}}\n</style>    \n    <title>CaptureCall Export Menu</title>\n        <script>\n    \n        var connection = new WebSocket('ws://' + location.host + '/ws/export');\n        var sender = new WebSocket('ws://' + location.host + '/ws/sender');\n        \n        var msg = 0; // Make Incoming WS Global\n\n        // When the connection is open, send some data to the server\n        connection.onopen = function() {\n            console.log('WebSocket Open');\n            connection.send('Open');\n        \n        };\n        connection.onclose = function() {\n            console.log('WebSocket Closed');\n        };\n        // Log errors\n        connection.onerror = function(error) {\n            console.log('WebSocket Error ' + error);\n        };\n        // Log messages from the server\n        connection.onmessage = function(d) {\n            var txt = d.data;\n            //msg = JSON.parse(txt);\n            console.log(txt)\n            document.getElementById(\"email\").value = txt;\n        };\n            // Log messages from the server\n        sender.onmessage = function(e) {\n            var txt0 = e.data;\n            //msg = JSON.parse(txt0);\n            console.log(txt0);\n           alert(txt0);\n        };\n        \n\n    </script>\n\n</head>\n<body>\n\n      <div class=\"heading\">\n\n    <div class=\"left\">\n        <a href=\"/display\" class=\"settings\" >Go to Dynamic Display</a>\n        <BR>\n        <a href=\"/log-daily\" class=\"settings\" >Go to Daily Log</a>    \n        <BR>\n        <a href=\"/log-full\" class=\"settings\" >Go to Full Log</a>\n        </div>\n    <div class=\"middle\">\n        <h1 id=\"title\">CaptureCall Export Menu</h1>\n    </div>\n    \n<div class=\"right\">\n<div class=\"settings\">System IP: {{{ip}}}</div>\n<div class=\"settings\">System Serial: 183701Q</div>\n<div class=\"settings\">S/W Version: 1.0.0</div>\n<div class=\"settings\">F/W Version: 1.0.0</div>\n<div class=\"settings\">H/W Version: 1.0.0</div>\n</div>\n    </div>\n\n\n<div class=\"grid-container\">\n<div class=\"grid-item\"><p class=\"notes\">Logs are sent to the email address shown below.<br>To update the email address, enter a new address below and press enter.</p><input type=\"email\" class=\"name\" id=\"email\" onchange=\"sender.send(email.value)\" placeholder=\"Enter eMail Address...\"></div>\n<div class=\"grid-item\"><p class=\"notes\">Click on the buttons below to email the relevant report immediately.</p><button class=\"name\" onclick=\"sender.send('ExportNew')\">Export New (Unexported) Log Records</button></div>\n<div class=\"grid-item\"><button class=\"name\" onclick=\"sender.send('ExportAll')\">Export All Log Records</button></div>\n<div class=\"grid-item\"><p class=\"notes bold\">WARNING: This cannot be undone!</p><button class=\"name red\" onclick=\"sender.send('Clear')\">Delete ALL Exported Records from Log</button></div>\n<div class=\"grid-item\"><p class=\"notes bold\">WARNING: You will need to physically disconnect and then re-connect power to CaptureCall in order to power-up again.</p><button class=\"name red\" onclick=\"sender.send('Shutdown')\">Safely Shutdown CaptureCall</button></div>\n</div>\n\n</body>\n\n</html>","output":"str","x":530,"y":80,"wires":[["51ac9ab9.85d7a4","8d1c3c15.f0953","3662df21.31d07"]]},{"id":"a258157e.a119c8","type":"template","z":"d686dfef.717a1","name":"Export New","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"SELECT\n`index` AS 'Index',\n`sender` AS 'Call Point',\n`content` AS 'Message',\n`rxTime`,\n`status` AS 'Status',\n`statusTime`,\n`exported`,\n`pagerNumber` AS 'Recipient',\n`sysID` AS 'System ID'\nFROM `log` WHERE `exported` IS NULL","output":"str","x":410,"y":400,"wires":[["dc12e674.582e68"]]},{"id":"ad45fecd.e4c27","type":"template","z":"d686dfef.717a1","name":"Clear","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"DELETE FROM `log` WHERE `exported` IS NOT NULL;","output":"str","x":450,"y":760,"wires":[["4434f7f7.8d0388"]]},{"id":"b77a3cc0.3f93a","type":"template","z":"d686dfef.717a1","name":"","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"UPDATE `log` SET `exported`= '{{timestamp}}'","output":"str","x":1760,"y":700,"wires":[["43e65779.533bd8"]]},{"id":"8e67a706.e90388","type":"change","z":"d686dfef.717a1","name":"","rules":[{"t":"set","p":"to","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":450,"y":500,"wires":[["ab995ac.51cb1a8","83da1ade.86cc08"]]},{"id":"8f8f06ba.2d63a8","type":"switch","z":"d686dfef.717a1","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"ExportNew","vt":"str"},{"t":"eq","v":"ExportAll","vt":"str"},{"t":"eq","v":"Clear","vt":"str"},{"t":"eq","v":"Shutdown","vt":"str"},{"t":"cont","v":"@","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":6,"x":270,"y":780,"wires":[["9cadf24b.8007"],["be7c3980.aef798"],["ad45fecd.e4c27"],["3dab060f.a59aca"],["f96e8148.b94c2"],["e643d0c4.d6a74"]]},{"id":"dc12e674.582e68","type":"sqlite","z":"d686dfef.717a1","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":590,"y":400,"wires":[["f33cd14c.33593"]]},{"id":"4434f7f7.8d0388","type":"sqlite","z":"d686dfef.717a1","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":590,"y":760,"wires":[["7b34686e.935b88"]]},{"id":"43e65779.533bd8","type":"sqlite","z":"d686dfef.717a1","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":1910,"y":700,"wires":[[]]},{"id":"76a84230.ef0c7c","type":"exec","z":"d686dfef.717a1","command":"shutdown -P now","addpay":false,"append":"","useSpawn":"","timer":"","oldrc":false,"name":"","x":810,"y":800,"wires":[[],[],[]]},{"id":"ab995ac.51cb1a8","type":"DataIn","z":"d686dfef.717a1","collection":"60d07179.968bc","name":"","update":false,"path":"/email","x":590,"y":500,"wires":[]},{"id":"9b020a06.d8cd78","type":"DataOut","z":"d686dfef.717a1","collection":"60d07179.968bc","name":"","path":"/email","error":false,"x":390,"y":220,"wires":[["d90f9309.ec4aa"]]},{"id":"9f99861e.5cbe08","type":"delay","z":"d686dfef.717a1","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":640,"y":800,"wires":[["76a84230.ef0c7c"]]},{"id":"554b0ae0.16e734","type":"websocket out","z":"d686dfef.717a1","name":"","server":"5cdd612c.78168","client":"","x":700,"y":220,"wires":[]},{"id":"ec4efdac.bd389","type":"websocket in","z":"d686dfef.717a1","name":"","server":"e0f20fd0.b6362","client":"","x":100,"y":780,"wires":[["8f8f06ba.2d63a8","283a4596.b99c4a"]]},{"id":"5c8516a.11eeee8","type":"change","z":"d686dfef.717a1","name":"","rules":[{"t":"set","p":"export","pt":"global","to":"Export Log Data Via eMail","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":420,"y":180,"wires":[[]]},{"id":"7a7e4914.1a6f28","type":"switch","z":"d686dfef.717a1","name":"","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":".","vt":"str"},{"t":"cont","v":",","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":170,"y":540,"wires":[["99c2b9ae.d48a28"],["d0f487d2.3b3a98"],["d0f487d2.3b3a98"]]},{"id":"99c2b9ae.d48a28","type":"switch","z":"d686dfef.717a1","name":"","property":"payload","propertyType":"msg","rules":[{"t":"jsonata_exp","v":"$length(payload) >= 5","vt":"jsonata"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":310,"y":520,"wires":[["8e67a706.e90388"],["d0f487d2.3b3a98"]]},{"id":"454dab33.2eddc4","type":"websocket out","z":"d686dfef.717a1","name":"Show Alert on Bad Email","server":"e0f20fd0.b6362","client":"","x":670,"y":560,"wires":[]},{"id":"9f6203f1.ae60a","type":"websocket in","z":"d686dfef.717a1","name":"","server":"5cdd612c.78168","client":"","x":100,"y":220,"wires":[["80334038.1bb6a"]]},{"id":"80334038.1bb6a","type":"switch","z":"d686dfef.717a1","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Open","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":250,"y":220,"wires":[["9b020a06.d8cd78","5c8516a.11eeee8"]]},{"id":"bd854842.7a00e8","type":"comment","z":"d686dfef.717a1","name":"Show Existing Email Address","info":"","x":140,"y":140,"wires":[]},{"id":"d0f487d2.3b3a98","type":"change","z":"d686dfef.717a1","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"Please Enter a Valid eMail Address","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":460,"y":560,"wires":[["454dab33.2eddc4"]]},{"id":"66d0621.3ec979c","type":"websocket out","z":"d686dfef.717a1","name":"Show Alert for Shutdown","server":"e0f20fd0.b6362","client":"","x":690,"y":880,"wires":[]},{"id":"3dab060f.a59aca","type":"change","z":"d686dfef.717a1","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"CaptureCall is Shutting Down... Please Close your Browser (If Necessary)","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":480,"y":800,"wires":[["66d0621.3ec979c","9f99861e.5cbe08","793f44fa.d56efc"]]},{"id":"94bae349.7d673","type":"change","z":"d686dfef.717a1","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"Your eMail has been Sent","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1460,"y":580,"wires":[["c4c592fa.8349e","f9ef3823.c6c438"]]},{"id":"c4c592fa.8349e","type":"websocket out","z":"d686dfef.717a1","name":"Send Successful","server":"e0f20fd0.b6362","client":"","x":1650,"y":580,"wires":[]},{"id":"7b34686e.935b88","type":"change","z":"d686dfef.717a1","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"Records Deleted","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":780,"y":760,"wires":[["44a028d6.aac8f8","3fee3499.c0672c"]]},{"id":"44a028d6.aac8f8","type":"websocket out","z":"d686dfef.717a1","name":"Show Alert for Clear Database","server":"e0f20fd0.b6362","client":"","x":1010,"y":760,"wires":[]},{"id":"ec9cb1b6.4084b","type":"template","z":"d686dfef.717a1","name":"","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` (`sender`, `status`, `content`, `statusTime`, `rxTime`) VALUES ('System', 'Power On','Power On ({{ip}})', '{{timestamp}}', '{{timestamp}}');","output":"str","x":820,"y":1020,"wires":[["bdbdc449.8d86e8"]]},{"id":"bdbdc449.8d86e8","type":"sqlite","z":"d686dfef.717a1","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":970,"y":1020,"wires":[[]]},{"id":"6fd6e96.4f88a18","type":"inject","z":"d686dfef.717a1","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":90,"y":1020,"wires":[["5276d661.6ce488"]]},{"id":"d508e914.b1b858","type":"template","z":"d686dfef.717a1","name":"","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` (`sender`, `status`, `content`, `statusTime`, `rxTime`) VALUES ('System', 'Power Off','Power Off', '{{timestamp}}', '{{timestamp}}');","output":"str","x":780,"y":840,"wires":[["4211df12.650f8"]]},{"id":"4211df12.650f8","type":"sqlite","z":"d686dfef.717a1","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":930,"y":840,"wires":[[]]},{"id":"9cc3049c.015cc8","type":"inject","z":"d686dfef.717a1","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":250,"y":180,"wires":[["9b020a06.d8cd78"]]},{"id":"d90f9309.ec4aa","type":"change","z":"d686dfef.717a1","name":"","rules":[{"t":"set","p":"to","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":530,"y":220,"wires":[["554b0ae0.16e734"]]},{"id":"989d94c8.159818","type":"change","z":"d686dfef.717a1","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"Send Failed","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1460,"y":540,"wires":[["f998f571.e3aa18","a1f1dc5b.5575e"]]},{"id":"f998f571.e3aa18","type":"websocket out","z":"d686dfef.717a1","name":"Send Failed","server":"e0f20fd0.b6362","client":"","x":1630,"y":540,"wires":[]},{"id":"eb01f10b.cdc8","type":"status","z":"d686dfef.717a1","name":"","scope":["5a62e1c4.8d678"],"x":1160,"y":560,"wires":[["cfdc8ac9.a419a8"]]},{"id":"cfdc8ac9.a419a8","type":"switch","z":"d686dfef.717a1","name":"","property":"status.text","propertyType":"msg","rules":[{"t":"eq","v":"email.status.sendfail","vt":"str"},{"t":"eq","v":"email.status.sending","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":1310,"y":560,"wires":[["989d94c8.159818"],[],["94bae349.7d673"]]},{"id":"b751e02e.aa6f4","type":"comment","z":"d686dfef.717a1","name":"Catch Email Send Errors","info":"","x":1170,"y":620,"wires":[]},{"id":"1fee60be.3e986f","type":"link in","z":"d686dfef.717a1","name":"","links":["825c5a5c.9ae458"],"x":295,"y":400,"wires":[["a258157e.a119c8"]]},{"id":"825c5a5c.9ae458","type":"link out","z":"d686dfef.717a1","name":"","links":["1fee60be.3e986f"],"x":875,"y":680,"wires":[]},{"id":"91b5e7a1.2eb468","type":"link in","z":"d686dfef.717a1","name":"","links":["e9050e92.d7f83"],"x":295,"y":440,"wires":[["20556d10.20ad12"]]},{"id":"e9050e92.d7f83","type":"link out","z":"d686dfef.717a1","name":"","links":["91b5e7a1.2eb468"],"x":875,"y":720,"wires":[]},{"id":"4c2ae02f.331d7","type":"comment","z":"d686dfef.717a1","name":"Send Email","info":"","x":150,"y":320,"wires":[]},{"id":"a01b0d7.79b97f","type":"inject","z":"d686dfef.717a1","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":90,"y":1060,"wires":[["defd64f5.851178"]]},{"id":"ef7cfda2.71f4","type":"comment","z":"d686dfef.717a1","name":"Log Power On & Set Last Email Address","info":"","x":180,"y":980,"wires":[]},{"id":"8dd5553a.fc0bc8","type":"link in","z":"d686dfef.717a1","name":"","links":["f96e8148.b94c2"],"x":75,"y":540,"wires":[["7a7e4914.1a6f28"]]},{"id":"f96e8148.b94c2","type":"link out","z":"d686dfef.717a1","name":"","links":["8dd5553a.fc0bc8"],"x":415,"y":840,"wires":[]},{"id":"86263fd9.b678","type":"link in","z":"d686dfef.717a1","name":"","links":["e643d0c4.d6a74"],"x":335,"y":580,"wires":[["d0f487d2.3b3a98"]]},{"id":"e643d0c4.d6a74","type":"link out","z":"d686dfef.717a1","name":"","links":["86263fd9.b678"],"x":415,"y":880,"wires":[]},{"id":"defd64f5.851178","type":"DataOut","z":"d686dfef.717a1","collection":"60d07179.968bc","name":"","path":"/email","error":false,"x":210,"y":1060,"wires":[["2813f3a0.4a283c"]]},{"id":"2813f3a0.4a283c","type":"change","z":"d686dfef.717a1","name":"","rules":[{"t":"set","p":"to","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":1060,"wires":[[]]},{"id":"ccde5759.798678","type":"comment","z":"d686dfef.717a1","name":"Set Email Address","info":"","x":150,"y":480,"wires":[]},{"id":"600a2a4c.bd1b54","type":"comment","z":"d686dfef.717a1","name":"Clear DB & Shutdown","info":"","x":120,"y":660,"wires":[]},{"id":"c037f395.0797a","type":"hostip","z":"d686dfef.717a1","name":"Host IP","x":240,"y":80,"wires":[["82b806b8.cf7458"]]},{"id":"82b806b8.cf7458","type":"change","z":"d686dfef.717a1","name":"","rules":[{"t":"set","p":"ip","pt":"msg","to":"payload[0].address","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":80,"wires":[["ec28d0d8.00efb"]]},{"id":"3662df21.31d07","type":"debug","z":"d686dfef.717a1","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":650,"y":120,"wires":[]},{"id":"6cf99996.668248","type":"csv","z":"d686dfef.717a1","name":"","sep":",","hdrin":"","hdrout":true,"multi":"one","ret":"\\n","temp":"Index, Call Point, Message, ReceivedTime, Status, StatusTime, ExportedTime, Recipient, System ID","skip":"0","x":950,"y":360,"wires":[["c2b21b0e.91d898","ec68fae6.db48b8"]]},{"id":"c2b21b0e.91d898","type":"change","z":"d686dfef.717a1","name":"Setup mail content","rules":[{"t":"set","p":"attachments","pt":"msg","to":"[{\t    \"filename\": 'log.csv', \t    \"content\": $$.payload\t}]","tot":"jsonata"},{"t":"set","p":"topic","pt":"msg","to":"CaptureCall Daily Digest","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"Attached is the requested information from your CaptureCall system.","tot":"str"},{"t":"set","p":"to","pt":"msg","to":"to","tot":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":1130,"y":360,"wires":[["5a62e1c4.8d678"]]},{"id":"4cf9700f.3aaf2","type":"template","z":"d686dfef.717a1","name":"Export New","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"SELECT\n`index` AS 'Index',\n`sender` AS 'Call Point',\n`content` AS 'Message',\n`rxTime`,\n`status` AS 'Status',\n`statusTime`,\n`exported`,\n`pagerNumber` AS 'Recipient',\n`sysID` AS 'System ID'\nFROM `log` WHERE `exported` IS NULL","output":"str","x":410,"y":360,"wires":[["10f2cb30.e48315"]]},{"id":"10f2cb30.e48315","type":"sqlite","z":"d686dfef.717a1","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":590,"y":360,"wires":[["4e5a3a5e.d2a2a4"]]},{"id":"70f26a97.e10194","type":"inject","z":"d686dfef.717a1","name":"Export New Every Day","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"00 00 * * *","once":false,"onceDelay":0.1,"x":210,"y":360,"wires":[["4cf9700f.3aaf2","bc07cdac.e9dad","1fe736a7.002129"]]},{"id":"5276d661.6ce488","type":"delay","z":"d686dfef.717a1","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"minute","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":230,"y":1020,"wires":[["3ef7728e.8d5d2e"]]},{"id":"3ada825a.9bd62e","type":"debug","z":"58f779e8.0e4218","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":650,"y":120,"wires":[]},{"id":"25bd0684.23d10a","type":"sqlite","z":"58f779e8.0e4218","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":490,"y":80,"wires":[["6726990f.d0d078"]]},{"id":"2770a75.db8da58","type":"inject","z":"58f779e8.0e4218","name":"Make Table","topic":"CREATE TABLE `log` ( \t`index`\tINTEGER PRIMARY KEY AUTOINCREMENT, \t`capcode`\tINTEGER, \t`pagerNumber`\tINTEGER, \t`sysID`\tINTEGER, \t`content`\tTEXT, \t`msgPart1`\tTEXT, \t`msgPart2`\tTEXT, \t`sender`\tTEXT, \t`rxTime`\tINTEGER, \t`status`\tTEXT, \t`statusTime`\tINTEGER, \t`exported`\tINTEGER );","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":330,"y":80,"wires":[["25bd0684.23d10a"]]},{"id":"6726990f.d0d078","type":"debug","z":"58f779e8.0e4218","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":650,"y":80,"wires":[]},{"id":"b242dc5f.4cf7c","type":"sqlite","z":"58f779e8.0e4218","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":490,"y":240,"wires":[["cc9ed3c3.5fa9"]]},{"id":"1138286f.565cb8","type":"inject","z":"58f779e8.0e4218","name":"Clear Table","topic":"DELETE FROM 'log';","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":330,"y":240,"wires":[["b242dc5f.4cf7c"]]},{"id":"96a8f1c8.fa11b","type":"sqlite","z":"58f779e8.0e4218","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":490,"y":120,"wires":[["3ada825a.9bd62e"]]},{"id":"5290ae9a.47c33","type":"inject","z":"58f779e8.0e4218","name":"Select All","topic":"Select * FROM 'log';","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":340,"y":120,"wires":[["96a8f1c8.fa11b"]]},{"id":"f2d122eb.072d8","type":"debug","z":"58f779e8.0e4218","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":650,"y":160,"wires":[]},{"id":"64e0c68f.5b6188","type":"sqlite","z":"58f779e8.0e4218","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":490,"y":160,"wires":[["f2d122eb.072d8"]]},{"id":"95d4354d.7910d8","type":"inject","z":"58f779e8.0e4218","name":"Drop Table","topic":"DROP TABLE 'log';","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":340,"y":160,"wires":[["64e0c68f.5b6188"]]},{"id":"8ef0a0b3.b6d3f","type":"switch","z":"1e3bcfcf.ac722","name":"Filter Address","property":"sysID","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":920,"y":360,"wires":[["8e09e944.ff4ca8"]]},{"id":"36825e76.ef7352","type":"comment","z":"1e3bcfcf.ac722","name":"Receive Page and Add to DB","info":"","x":160,"y":260,"wires":[]},{"id":"e867ec81.16155","type":"comment","z":"1e3bcfcf.ac722","name":"Put Unprocessed On the Webpage","info":"","x":180,"y":140,"wires":[]},{"id":"76933338.734b8c","type":"template","z":"1e3bcfcf.ac722","name":"Select Active Data","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"SELECT `index`, `pagerNumber`, `sysID`, `content`, `msgPart1`, `msgPart2`, `sender`, `rxTime`, `status`\nFROM `log`\nWHERE  `status` = 'Active' OR `status` = 'Late'\nORDER BY  `rxTime` DESC ","output":"str","x":290,"y":200,"wires":[["d5da6cc9.fe419"]]},{"id":"dbe2df6d.83a08","type":"websocket out","z":"1e3bcfcf.ac722","name":"","server":"d471fcd2.f0968","client":"","x":1320,"y":200,"wires":[]},{"id":"ac70cd88.aa2f7","type":"template","z":"1e3bcfcf.ac722","name":"Add Msg to DB as Active","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` ('capcode', 'pagerNumber', 'sysID', 'content', 'msgPart1', 'msgPart2', 'sender', 'rxTime', 'status', 'statusTime') VALUES ('{{capcode}}', '{{pagerNumber}}', '{{sysID}}', '{{content}}', '{{msgPart1}}', '{{msgPart2}}', '{{sender}}','{{timestamp}}', 'Active', '{{timestamp}}');","output":"str","x":1490,"y":400,"wires":[["d1dfdd51.77817"]]},{"id":"d5da6cc9.fe419","type":"sqlite","z":"1e3bcfcf.ac722","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":470,"y":200,"wires":[["dceecf04.d8c2d"]]},{"id":"d1dfdd51.77817","type":"sqlite","z":"1e3bcfcf.ac722","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":1710,"y":360,"wires":[["17f84f5b.37d0c1"]]},{"id":"3932628.05e9f9e","type":"serial in","z":"1e3bcfcf.ac722","name":"","serial":"5461daa4.49fb24","x":90,"y":360,"wires":[["d04739fb.927bb8"]]},{"id":"8e09e944.ff4ca8","type":"change","z":"1e3bcfcf.ac722","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":1080,"y":360,"wires":[["58da0a23.841f24"]]},{"id":"58da0a23.841f24","type":"switch","z":"1e3bcfcf.ac722","name":"Check Msg Type","property":"content","propertyType":"msg","rules":[{"t":"cont","v":"Handled","vt":"str"},{"t":"cont","v":"Late","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":1250,"y":360,"wires":[["4fe27a9c.d74524"],["f9f02a1b.1be4d8"],["ac70cd88.aa2f7"]]},{"id":"f9f02a1b.1be4d8","type":"template","z":"1e3bcfcf.ac722","name":"Add Msg to DB as Late","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` ('capcode', 'pagerNumber', 'sysID', 'content', 'msgPart1', 'msgPart2', 'sender', 'rxTime', 'status', 'statusTime') VALUES ('{{capcode}}', '{{pagerNumber}}', '{{sysID}}', '{{content}}', '{{msgPart1}}', '{{msgPart2}}', '{{sender}}','{{timestamp}}', 'Late', '{{timestamp}}');","output":"str","x":1490,"y":360,"wires":[["d1dfdd51.77817"]]},{"id":"4fe27a9c.d74524","type":"template","z":"1e3bcfcf.ac722","name":"Add Msg to DB as Handled","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` ('capcode', 'pagerNumber', 'sysID', 'content', 'msgPart1', 'msgPart2', 'sender', 'rxTime', 'status', 'statusTime') VALUES ('{{capcode}}', '{{pagerNumber}}', '{{sysID}}', '{{content}}', '{{msgPart1}}', '{{msgPart2}}', '{{sender}}','{{timestamp}}', 'Attended', '{{timestamp}}');","output":"str","x":1500,"y":320,"wires":[["d69fd8ef.01ffc8"]]},{"id":"e300c099.e87b2","type":"template","z":"1e3bcfcf.ac722","name":"Update Active to Handled","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"UPDATE `log` SET status = 'Handled', statusTime = '{{timestamp}}' WHERE `sender` = {{sender}} AND `status` = 'Active';","output":"str","x":1910,"y":320,"wires":[["4fed277b.2a8aa8"]]},{"id":"4fed277b.2a8aa8","type":"sqlite","z":"1e3bcfcf.ac722","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":2110,"y":320,"wires":[["b3368d7b.2b46e"]]},{"id":"d69fd8ef.01ffc8","type":"sqlite","z":"1e3bcfcf.ac722","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":1710,"y":320,"wires":[["e300c099.e87b2"]]},{"id":"17f84f5b.37d0c1","type":"link out","z":"1e3bcfcf.ac722","name":"to Log","links":["549c31fe.97ffc"],"x":2615,"y":320,"wires":[]},{"id":"22f95eb3.4b9422","type":"template","z":"1e3bcfcf.ac722","name":"Build Data","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"  <div class=\"nested\">\n        <div class=\"bold\">Index</div>\n        <div class=\"bold\">Location</div>\n        <div class=\"bold\">Message</div>\n        <div class=\"bold\">Time</div>\n        <div class=\"bold\">Date</div>\n        <div class=\"bold\">Elapsed</div>\n      </div>\n{{#payload}}\n  <div class=\"nested {{style}}\" onclick= send.send('{{index}}')>\n        <div>{{{index}}}</div>\n        <div>{{{msgPart1}}}</div>\n        <div>{{{msgPart2}}}</div>\n        <div>{{{displayTime}}}</div>\n        <div>{{{displayDate}}}</div>\n        <div>{{{elapsed}}}</div>\n      </div>\n{{/payload}}","output":"str","x":1150,"y":200,"wires":[["dbe2df6d.83a08"]]},{"id":"84f3ad59.90ac","type":"function","z":"1e3bcfcf.ac722","name":"Convert Time to local","func":"var array = msg.payload\nvar i;\nfor (i = 0; i < array.length; i++) { \n   var rxtime = new Date(msg.payload[i].rxTime);\n                var displayDate = rxtime.toLocaleDateString();\n                var displayTime = rxtime.toLocaleTimeString();\n                \n                msg.payload[i].displayDate = displayDate\n                msg.payload[i].displayTime = displayTime\n}\n    \n \n\nreturn msg;","outputs":1,"noerr":0,"x":800,"y":200,"wires":[["cf23e987.a2f418"]]},{"id":"cf23e987.a2f418","type":"function","z":"1e3bcfcf.ac722","name":"Time elapsed","func":"var array = msg.payload\nvar i;\nfor (i = 0; i < array.length; i++) { \n   var rxtime = msg.payload[i].rxTime;\n   var now = Date.now();\n   \nvar elapsedTS = now -rxtime;\nvar elapsedS = parseInt(elapsedTS / 1000);\n\nvar date = new Date(null);  \ndate.setSeconds(elapsedS); // specify value for SECONDS here\nvar elapsed = date.toISOString().substr(11, 8);        \n\nmsg.payload[i].elapsed = elapsed\n\n}\n    \n \n\nreturn msg;","outputs":1,"noerr":0,"x":990,"y":200,"wires":[["22f95eb3.4b9422"]]},{"id":"cf4d34f2.6c1f18","type":"inject","z":"1e3bcfcf.ac722","name":"","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":200,"wires":[["76933338.734b8c"]]},{"id":"d04739fb.927bb8","type":"switch","z":"1e3bcfcf.ac722","name":"MSG Type","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"[","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":250,"y":360,"wires":[["5c74aa5e.e37744"],["8396b592.6f6278"]]},{"id":"5c74aa5e.e37744","type":"function","z":"1e3bcfcf.ac722","name":"LRS Process Group Message","func":"var payload = msg.payload;\nvar Totallength = payload.length;\n\nvar page = payload.substring(9, Totallength -2);\n\n\nvar str = \"\" + page;\nvar split = str.split(\",\");\nvar contentlength = split[1].length\n\n\n\nvar capcode = split[0];\nvar str = capcode.toString();\nvar strLength = str.length;\nvar pagerStr = str.substring(strLength - 5, strLength);\nvar pagercalc1 = parseInt(pagerStr);\nvar pager = pagercalc1/8;\n\nvar syscode = ((capcode - pagercalc1)-700000)/100000;\n\nif (page.endsWith(\" \")) {\n    var message= split[1].substring(4,contentlength-1)\nvar tidyMessage = message.trim();\n    msg.sender = \"0\"\n} else {\n    var message= split[1].substring(4,contentlength-2)\nvar tidyMessage = message.trim();\n    var sender = split[1].substring(contentlength-2,contentlength)\n    var tidySender = sender.trim();\n    msg.sender = tidySender;\n}\n\nvar group= split[1].substring(0,4)\n\nmsg.capcode = split[0];\nmsg.pagerNumber = group;\nmsg.sysID = syscode\nmsg.content = tidyMessage;\nmsg.payload = page\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":340,"wires":[["28109660.2cccaa"]]},{"id":"8396b592.6f6278","type":"function","z":"1e3bcfcf.ac722","name":"LRS Process Normal Message","func":"var payload = msg.payload;\nvar Totallength = payload.length;\n\nvar page = payload.substring(9, Totallength -2);\n\n\nvar str = \"\" + page;\nvar split = str.split(\",\");\nvar contentlength = split[1].length\n\n\n\nvar capcode = split[0];\nvar str = capcode.toString();\nvar strLength = str.length;\nvar pagerStr = str.substring(strLength - 5, strLength);\nvar pagercalc1 = parseInt(pagerStr);\nvar pager = pagercalc1/8;\n\nvar syscode = ((capcode - pagercalc1)-700000)/100000;\n\nif (page.endsWith(\" \")) {\n    var message= split[1].substring(0,contentlength-1)\nvar tidyMessage = message.trim();\n    msg.sender = \"0\"\n} else {\n    var message= split[1].substring(0,contentlength-2)\nvar tidyMessage = message.trim();\n    var sender = split[1].substring(contentlength-2,contentlength)\n    var tidySender = sender.trim();\n    msg.sender = tidySender;\n}\n\n\nmsg.capcode = split[0];\nmsg.pagerNumber = pager\nmsg.sysID = syscode\nmsg.content = tidyMessage;\nmsg.payload = page\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":380,"wires":[["28109660.2cccaa"]]},{"id":"9645b91c.5ea768","type":"websocket in","z":"1e3bcfcf.ac722","name":"","server":"87b7d713.a17d18","client":"","x":90,"y":500,"wires":[["1b62ee7e.e05062"]]},{"id":"44317f64.3b1ce","type":"comment","z":"1e3bcfcf.ac722","name":"Hide Message on Click","info":"","x":120,"y":460,"wires":[]},{"id":"6a40fd83.66f3d4","type":"template","z":"1e3bcfcf.ac722","name":"Update Active to Handled","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"UPDATE `log` SET status = 'Manually Removed', statusTime = '{{timestamp}}' WHERE `index` = {{payload}};","output":"str","x":430,"y":500,"wires":[["518333d8.c60dec"]]},{"id":"518333d8.c60dec","type":"sqlite","z":"1e3bcfcf.ac722","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":630,"y":500,"wires":[["aaa0058d.328208"]]},{"id":"aaa0058d.328208","type":"link out","z":"1e3bcfcf.ac722","name":"","links":["549c31fe.97ffc","740b1d9c.97ec34"],"x":735,"y":500,"wires":[]},{"id":"1b62ee7e.e05062","type":"change","z":"1e3bcfcf.ac722","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":240,"y":500,"wires":[["6a40fd83.66f3d4"]]},{"id":"b3368d7b.2b46e","type":"template","z":"1e3bcfcf.ac722","name":"Update Late to Handled","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"UPDATE `log` SET status = 'Handled', statusTime = '{{timestamp}}' WHERE `sender` = {{sender}} AND `status` = 'Late';","output":"str","x":2310,"y":320,"wires":[["824d91b1.99f1a"]]},{"id":"824d91b1.99f1a","type":"sqlite","z":"1e3bcfcf.ac722","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":2510,"y":320,"wires":[["17f84f5b.37d0c1"]]},{"id":"271b6b4b.87d7a4","type":"comment","z":"11ba16cf.809619","name":"Put All On the Webpage","info":"","x":160,"y":140,"wires":[]},{"id":"286f1cfc.59f004","type":"http response","z":"11ba16cf.809619","name":"","statusCode":"","headers":{},"x":550,"y":80,"wires":[]},{"id":"3fc9fb7c.094674","type":"http in","z":"11ba16cf.809619","name":"","url":"/log-full","method":"get","upload":false,"swaggerDoc":"","x":130,"y":80,"wires":[["b778e8b7.94ebe8"]]},{"id":"ab7f50ca.0973e","type":"template","z":"11ba16cf.809619","name":"Select Active Data","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"SELECT * FROM `log`\nORDER BY  `rxTime` DESC ","output":"str","x":230,"y":280,"wires":[["4cfb0a90.a79ad4"]]},{"id":"d151942.1f16a68","type":"websocket out","z":"11ba16cf.809619","name":"","server":"8ad92631.0da208","client":"","x":1090,"y":280,"wires":[]},{"id":"df5bc503.c44578","type":"comment","z":"11ba16cf.809619","name":"Build Webpage","info":"","x":140,"y":40,"wires":[]},{"id":"4cfb0a90.a79ad4","type":"sqlite","z":"11ba16cf.809619","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":410,"y":280,"wires":[["dc4fbf9b.e97cf"]]},{"id":"cb15e045.1d484","type":"template","z":"11ba16cf.809619","name":"Build Data","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"  <div class=\"nestedLog\">\n    <div class=\"bold\">Index</div>\n    <div class=\"bold\">Call Point</div>\n    <div class=\"bold\">Message</div>\n    <div class=\"bold\">Receive Time</div>\n    <div class=\"bold\">Receive Date</div>\n    <div class=\"bold\">Status</div>\n    <div class=\"bold\">Status Time</div>\n    <div class=\"bold\">Status Date</div>\n    <div class=\"bold\">Export Time</div>\n    <div class=\"bold\">Export Date</div>\n    <div class=\"bold\">Recipient</div>\n    <div class=\"bold\">System ID</div>\n  </div>\n{{#payload}}\n  <div class=\"nestedLog {{style}}\">\n    <div>{{index}}</div>\n    <div>{{sender}}</div>\n    <div>{{{content}}}</div>\n    <div>{{displayTime}}</div>\n    <div>{{displayDate}}</div>\n    <div>{{status}}</div>\n    <div>{{displayStatusTime}}</div>\n    <div>{{displayStatusDate}}</div>\n    <div>{{{displayExportedTime}}}</div>\n    <div>{{{displayExportedDate}}}</div>\n    <div>{{pagerNumber}}</div>\n    <div>{{sysID}}</div>\n   </div>\n{{/payload}}","output":"str","x":930,"y":280,"wires":[["d151942.1f16a68"]]},{"id":"b778e8b7.94ebe8","type":"template","z":"11ba16cf.809619","name":"Script","field":"script","fieldType":"msg","format":"javascript","syntax":"plain","template":"    var receive = new WebSocket('ws://' + location.host + '/ws/data');\n\n        var msg = 0; // Make Incoming WS Global\n\n        // Log messages from the server\n        receive.onmessage = function(d) {\n            var txt = d.data;\n            msg = JSON.parse(txt);\n            console.log(msg);\n            document.getElementById(\"data\").innerHTML = msg.payload;\n        };\n        \n            // When the connection is open, send some data to the server\n        receive.onopen = function() {\n            console.log('WebSocket Open');\n            receive.send('Open');\n        \n        };\n\nfunction startTime() {\n    var today = new Date();\n    var h = today.getHours();\n    var m = today.getMinutes();\n    var s = today.getSeconds();\n    m = checkTime(m);\n    s = checkTime(s);\n    document.getElementById('time').innerHTML =\n    h + \":\" + m + \":\" + s;\n    var t = setTimeout(startTime, 500);\n} //Clock\n\nfunction checkTime(i) {\n    if (i < 10) {i = \"0\" + i}  // add zero in front of numbers < 10\n    return i;\n}\n     ","output":"str","x":290,"y":80,"wires":[["1a6c83b7.9ed1fc"]]},{"id":"ba8cac2.2141f5","type":"function","z":"11ba16cf.809619","name":"Convert Time to local","func":"var array = msg.payload\nvar i;\nfor (i = 0; i < array.length; i++) { \n   var rxtime = new Date(msg.payload[i].rxTime);\n                var displayDate = rxtime.toLocaleDateString();\n                var displayTime = rxtime.toLocaleTimeString();\n                \n    var statusTime = new Date(msg.payload[i].statusTime);\n                var displayStatusDate = statusTime.toLocaleDateString();\n                var displayStatusTime = statusTime.toLocaleTimeString();\n                \n  \n              \n     if (msg.payload[i].exported === null) {\n    msg.payload[i].displayExportedTime = \"n/a\"\n    msg.payload[i].displayExportedDate = \"n/a\"\n} else {\nvar exportedTime = new Date(msg.payload[i].exported);\n    var displayExportedDate = exportedTime.toLocaleDateString();\n    var displayExportedTime = exportedTime.toLocaleTimeString();\n              \n    msg.payload[i].displayExportedTime = displayExportedTime\n    msg.payload[i].displayExportedDate = displayExportedDate\n}         \n               \n                \n                msg.payload[i].displayStatusTime = displayStatusTime\n                msg.payload[i].displayStatusDate = displayStatusDate\n                \n                msg.payload[i].displayDate = displayDate\n                msg.payload[i].displayTime = displayTime\n}\n    \n \n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":280,"wires":[["cb15e045.1d484","bcfdb8d7.6e4268"]]},{"id":"549c31fe.97ffc","type":"link in","z":"11ba16cf.809619","name":"log","links":["17f84f5b.37d0c1","aaa0058d.328208","1bfc9a0a.cba736","d2d8b8d2.67e9a8","9a7595f4.a65cc8"],"x":95,"y":280,"wires":[["ab7f50ca.0973e"]]},{"id":"bcfdb8d7.6e4268","type":"debug","z":"11ba16cf.809619","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":910,"y":220,"wires":[]},{"id":"a40c7635.2d15b8","type":"websocket in","z":"11ba16cf.809619","name":"","server":"8ad92631.0da208","client":"","x":150,"y":220,"wires":[["625456e9.d482e8"]]},{"id":"625456e9.d482e8","type":"switch","z":"11ba16cf.809619","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Open","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":290,"y":220,"wires":[["ab7f50ca.0973e"]]},{"id":"4e5a3a5e.d2a2a4","type":"function","z":"d686dfef.717a1","name":"Convert Time to local","func":"var array = msg.payload\nvar i;\nfor (i = 0; i < array.length; i++) { \nvar rxtime = new Date(msg.payload[i].rxTime);\nvar statusTime = new Date(msg.payload[i].statusTime);\nvar exportedTime = new Date(msg.payload[i].exported);\n\nif (msg.payload[i].exported === null) {\n    msg.payload[i].ExportedTime = \"n/a\"\n} else {\nmsg.payload[i].ExportedTime = exportedTime\n}\n\nmsg.payload[i].StatusTime = statusTime\nmsg.payload[i].ReceivedTime = rxtime\n}\n    \n \n\nreturn msg;","outputs":1,"noerr":0,"x":780,"y":360,"wires":[["6cf99996.668248"]]},{"id":"f9ef3823.c6c438","type":"change","z":"d686dfef.717a1","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":1620,"y":660,"wires":[["69baf65a.ed3ad8","b77a3cc0.3f93a"]]},{"id":"f33cd14c.33593","type":"function","z":"d686dfef.717a1","name":"Convert Time to local","func":"var array = msg.payload\nvar i;\nfor (i = 0; i < array.length; i++) { \nvar rxtime = new Date(msg.payload[i].rxTime);\nvar statusTime = new Date(msg.payload[i].statusTime);\nvar exportedTime = new Date(msg.payload[i].exported);\n\nif (msg.payload[i].exported === null) {\n    msg.payload[i].ExportedTime = \"n/a\"\n} else {\nmsg.payload[i].ExportedTime = exportedTime\n}\n\nmsg.payload[i].StatusTime = statusTime\nmsg.payload[i].ReceivedTime = rxtime\n}\n    \n \n\nreturn msg;","outputs":1,"noerr":0,"x":780,"y":400,"wires":[["f206d4bc.401878"]]},{"id":"793f44fa.d56efc","type":"change","z":"d686dfef.717a1","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":640,"y":840,"wires":[["d508e914.b1b858"]]},{"id":"3ef7728e.8d5d2e","type":"change","z":"d686dfef.717a1","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":1020,"wires":[["356690db.e0bd"]]},{"id":"704a769.e516288","type":"change","z":"d686dfef.717a1","name":"","rules":[{"t":"set","p":"ip","pt":"msg","to":"payload[0].address","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":670,"y":1020,"wires":[["ec9cb1b6.4084b"]]},{"id":"356690db.e0bd","type":"hostip","z":"d686dfef.717a1","name":"Host IP","x":520,"y":1020,"wires":[["704a769.e516288"]]},{"id":"cc9ed3c3.5fa9","type":"debug","z":"58f779e8.0e4218","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":650,"y":240,"wires":[]},{"id":"a9edb0d6.c3e3c","type":"debug","z":"58f779e8.0e4218","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":650,"y":200,"wires":[]},{"id":"4e92e6e8.e59908","type":"sqlite","z":"58f779e8.0e4218","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":490,"y":200,"wires":[["a9edb0d6.c3e3c"]]},{"id":"c0692ac7.1300f8","type":"inject","z":"58f779e8.0e4218","name":"Reset Auto Increment (Clear Table First)","topic":"DELETE FROM sqlite_sequence WHERE name = 'log';","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":240,"y":200,"wires":[["4e92e6e8.e59908"]]},{"id":"1a6c83b7.9ed1fc","type":"template","z":"11ba16cf.809619","name":"HTML","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<!DOCTYPE html>\n<html>\n<head>\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    \n   <title>CaptureCall Full Log</title>\n   <style>\n        {{{global.css}}}\n    </style>\n    \n    <script>\n        {{{script}}}\n    </script>\n    \n \n\n</head>\n\n<body onload=\"startTime()\">\n\n      <div class=\"heading\">\n\n    <div class=\"left\">\n        <a href=\"/export\" class=\"settings\">Go to Export Menu</a>\n        <BR>\n        <a href=\"/display\" class=\"settings\" >Go to Dynamic Display</a>\n        <BR>\n        <a href=\"/log-daily\" class=\"settings\" >Go to Daily Log</a>    \n    </div>\n    <div class=\"middle\">\n        <h1 id=\"title\">CaptureCall Full Log</h1>\n    </div>\n    \n    <div class=\"right\">\n    <div class=\"clock\" id=\"time\"></div>\n    </div>\n    \n    </div>\n\n      <div class=\"wrapper\" id=\"data\"></div>\n\n</body>\n\n</html>","output":"str","x":430,"y":80,"wires":[["286f1cfc.59f004"]]},{"id":"ec68fae6.db48b8","type":"debug","z":"d686dfef.717a1","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1090,"y":320,"wires":[]},{"id":"363f60cf.92ec5","type":"comment","z":"599bf1f1.c3be9","name":"Put All On the Webpage","info":"","x":160,"y":140,"wires":[]},{"id":"38a04605.fd5d6a","type":"http response","z":"599bf1f1.c3be9","name":"","statusCode":"","headers":{},"x":510,"y":80,"wires":[]},{"id":"862170ff.2b6bb","type":"http in","z":"599bf1f1.c3be9","name":"","url":"/log-daily","method":"get","upload":false,"swaggerDoc":"","x":130,"y":80,"wires":[["dee81ae6.e0f9e8"]]},{"id":"e37e687.c92b198","type":"template","z":"599bf1f1.c3be9","name":"Select Active Data","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"SELECT * FROM log WHERE date(datetime(rxtime / 1000 , 'unixepoch')) = date('now') AND `sender` != \"System\"\nORDER BY  `rxTime` DESC; ","output":"str","x":230,"y":280,"wires":[["d853ed54.61b84"]]},{"id":"a3ab05ba.c15fb8","type":"websocket out","z":"599bf1f1.c3be9","name":"","server":"48f558f0.c51958","client":"","x":1100,"y":280,"wires":[]},{"id":"9d76bbfe.805968","type":"comment","z":"599bf1f1.c3be9","name":"Build Webpage","info":"","x":140,"y":40,"wires":[]},{"id":"d853ed54.61b84","type":"sqlite","z":"599bf1f1.c3be9","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":410,"y":280,"wires":[["4930c76f.cd2a98"]]},{"id":"2eccabed.1df564","type":"template","z":"599bf1f1.c3be9","name":"Build Data","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"  <div class=\"nested10\">\n    <div class=\"bold\">Index</div>\n    <div class=\"bold\">Call Point</div>\n    <div class=\"bold\">Message</div>\n    <div class=\"bold\">Receive Time</div>\n    <div class=\"bold\">Receive Date</div>\n    <div class=\"bold\">Status</div>\n    <div class=\"bold\">Status Time</div>\n    <div class=\"bold\">Status Date</div>\n    \n    <div class=\"bold\">Recipient</div>\n    <div class=\"bold\">System ID</div>\n  </div>\n{{#payload}}\n  <div class=\"nested10 {{style}}\">\n    <div>{{index}}</div>\n    <div>{{sender}}</div>\n    <div>{{{content}}}</div>\n    <div>{{displayTime}}</div>\n    <div>{{displayDate}}</div>\n    <div>{{status}}</div>\n    <div>{{displayStatusTime}}</div>\n    <div>{{displayStatusDate}}</div>\n   \n    <div>{{pagerNumber}}</div>\n    <div>{{sysID}}</div>\n   </div>\n{{/payload}}","output":"str","x":930,"y":280,"wires":[["a3ab05ba.c15fb8"]]},{"id":"dee81ae6.e0f9e8","type":"template","z":"599bf1f1.c3be9","name":"Script","field":"script","fieldType":"msg","format":"javascript","syntax":"plain","template":"    var receive = new WebSocket('ws://' + location.host + '/ws/data1');\n\n        var msg = 0; // Make Incoming WS Global\n\n        // Log messages from the server\n        receive.onmessage = function(d) {\n            var txt = d.data;\n            msg = JSON.parse(txt);\n            console.log(msg);\n            document.getElementById(\"data\").innerHTML = msg.payload;\n        };\n        \n            // When the connection is open, send some data to the server\n        receive.onopen = function() {\n            console.log('WebSocket Open');\n            receive.send('Open');\n        \n        };\n\nfunction startTime() {\n    var today = new Date();\n    var h = today.getHours();\n    var m = today.getMinutes();\n    var s = today.getSeconds();\n    m = checkTime(m);\n    s = checkTime(s);\n    document.getElementById('time').innerHTML =\n    h + \":\" + m + \":\" + s;\n    var t = setTimeout(startTime, 500);\n} //Clock\n\nfunction checkTime(i) {\n    if (i < 10) {i = \"0\" + i}  // add zero in front of numbers < 10\n    return i;\n}\n     ","output":"str","x":270,"y":80,"wires":[["8c1ef6dc.c71488"]]},{"id":"68309b06.3cb724","type":"function","z":"599bf1f1.c3be9","name":"Convert Time to local","func":"var array = msg.payload\nvar i;\nfor (i = 0; i < array.length; i++) { \n   var rxtime = new Date(msg.payload[i].rxTime);\n                var displayDate = rxtime.toLocaleDateString();\n                var displayTime = rxtime.toLocaleTimeString();\n                \n    var statusTime = new Date(msg.payload[i].statusTime);\n                var displayStatusDate = statusTime.toLocaleDateString();\n                var displayStatusTime = statusTime.toLocaleTimeString();\n                \n  \n              \n     if (msg.payload[i].exported === null) {\n    msg.payload[i].displayExportedTime = \"n/a\"\n    msg.payload[i].displayExportedDate = \"n/a\"\n} else {\nvar exportedTime = new Date(msg.payload[i].exported);\n    var displayExportedDate = exportedTime.toLocaleDateString();\n    var displayExportedTime = exportedTime.toLocaleTimeString();\n              \n    msg.payload[i].displayExportedTime = displayExportedTime\n    msg.payload[i].displayExportedDate = displayExportedDate\n}         \n               \n                \n                msg.payload[i].displayStatusTime = displayStatusTime\n                msg.payload[i].displayStatusDate = displayStatusDate\n                \n                msg.payload[i].displayDate = displayDate\n                msg.payload[i].displayTime = displayTime\n}\n    \n \n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":280,"wires":[["2eccabed.1df564","f9a091d1.1a617"]]},{"id":"740b1d9c.97ec34","type":"link in","z":"599bf1f1.c3be9","name":"log","links":["17f84f5b.37d0c1","aaa0058d.328208","1bfc9a0a.cba736","d2d8b8d2.67e9a8","9a7595f4.a65cc8"],"x":95,"y":280,"wires":[["e37e687.c92b198"]]},{"id":"f9a091d1.1a617","type":"debug","z":"599bf1f1.c3be9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":910,"y":220,"wires":[]},{"id":"62786dbd.b093b4","type":"websocket in","z":"599bf1f1.c3be9","name":"","server":"48f558f0.c51958","client":"","x":150,"y":220,"wires":[["5d5cbf8f.005da"]]},{"id":"5d5cbf8f.005da","type":"switch","z":"599bf1f1.c3be9","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Open","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":290,"y":220,"wires":[["e37e687.c92b198"]]},{"id":"8c1ef6dc.c71488","type":"template","z":"599bf1f1.c3be9","name":"HTML","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<!DOCTYPE html>\n<html>\n<head>\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    \n   <title>CaptureCall Daily Log</title>\n   <style>\n        {{{global.css}}}\n    </style>\n    \n    <script>\n        {{{script}}}\n    </script>\n    \n \n\n</head>\n\n<body onload=\"startTime()\">\n\n      <div class=\"heading\">\n\n    <div class=\"left\">\n        \n       <a href=\"/export\" class=\"settings\">Go to Export Menu</a>\n        <BR>\n        <a href=\"/display\" class=\"settings\" >Go to Dynamic Display</a>\n        <BR>\n        <a href=\"/log-full\" class=\"settings\" >Go to Full Log</a>\n        </div>\n    <div class=\"middle\">\n        <h1 id=\"title\">CaptureCall Daily Log</h1>\n    </div>\n    \n    <div class=\"right\">\n        \n        <div class=\"clock\" id=\"time\"></div>\n    </div>\n    \n    </div>\n\n      <div class=\"wrapper\" id=\"data\"></div>\n\n</body>\n\n</html>","output":"str","x":390,"y":80,"wires":[["38a04605.fd5d6a"]]},{"id":"b55ff2b0.81607","type":"sqlite","z":"58f779e8.0e4218","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":490,"y":280,"wires":[["3e384c17.2d6a44"]]},{"id":"ea25258f.7fa4f8","type":"inject","z":"58f779e8.0e4218","name":"Clear Old Records","topic":"DELETE FROM `log` WHERE `index` IN (SELECT `index` FROM `log` ORDER BY `index` DESC LIMIT -1 OFFSET 2000) AND `exported` IS NOT NULL;","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":310,"y":280,"wires":[["b55ff2b0.81607"]]},{"id":"3e384c17.2d6a44","type":"debug","z":"58f779e8.0e4218","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":650,"y":280,"wires":[]},{"id":"ce5adef3.e243d","type":"template","z":"d686dfef.717a1","name":"Clear Old Records","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"DELETE FROM `log` WHERE `index` IN (SELECT `index` FROM `log` ORDER BY `index` DESC LIMIT -1 OFFSET 2000) AND `exported` IS NOT NULL;","output":"str","x":570,"y":320,"wires":[["a22496a6.012178"]]},{"id":"a22496a6.012178","type":"sqlite","z":"d686dfef.717a1","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":750,"y":320,"wires":[[]]},{"id":"bc07cdac.e9dad","type":"delay","z":"d686dfef.717a1","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":400,"y":320,"wires":[["ce5adef3.e243d"]]},{"id":"69baf65a.ed3ad8","type":"template","z":"d686dfef.717a1","name":"","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` (`sender`, `status`, `content`, `statusTime`, `rxTime`) VALUES ('System', 'Export Successful','Export Successful', '{{timestamp}}', '{{timestamp}}');","output":"str","x":1760,"y":660,"wires":[["8f909dc2.895a2"]]},{"id":"8f909dc2.895a2","type":"sqlite","z":"d686dfef.717a1","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":1910,"y":660,"wires":[[]]},{"id":"38044fdc.3c623","type":"template","z":"d686dfef.717a1","name":"","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` (`sender`, `status`, `content`, `statusTime`, `rxTime`) VALUES ('System', 'Export Failed','Export Failed', '{{timestamp}}', '{{timestamp}}');","output":"str","x":1760,"y":500,"wires":[["ae0ffe1b.2fa98"]]},{"id":"ae0ffe1b.2fa98","type":"sqlite","z":"d686dfef.717a1","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":1910,"y":500,"wires":[[]]},{"id":"265a73de.be9f3c","type":"template","z":"d686dfef.717a1","name":"Log Export","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` (`sender`, `status`, `content`, `statusTime`, `rxTime`) VALUES ('System', 'Export All','Export All to {{global.to}}', '{{timestamp}}', '{{timestamp}}');","output":"str","x":610,"y":720,"wires":[["4ac6bda9.5742f4"]]},{"id":"4ac6bda9.5742f4","type":"sqlite","z":"d686dfef.717a1","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":770,"y":720,"wires":[["e9050e92.d7f83"]]},{"id":"e55b3b85.abff48","type":"template","z":"d686dfef.717a1","name":"Log Export","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` (`sender`, `status`, `content`, `statusTime`, `rxTime`) VALUES ('System', 'Export New','Export New to {{global.to}}', '{{timestamp}}', '{{timestamp}}');","output":"str","x":610,"y":680,"wires":[["ef021ab8.ffcc58"]]},{"id":"ef021ab8.ffcc58","type":"sqlite","z":"d686dfef.717a1","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":770,"y":680,"wires":[["825c5a5c.9ae458"]]},{"id":"ff00ae16.65327","type":"template","z":"d686dfef.717a1","name":"Log Export","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` (`sender`, `status`, `content`, `statusTime`, `rxTime`) VALUES ('System', 'Daily Export Triggered','Daily Export Triggered to {{global.to}}', '{{timestamp}}', '{{timestamp}}');","output":"str","x":550,"y":280,"wires":[["30f39dc2.844642"]]},{"id":"30f39dc2.844642","type":"sqlite","z":"d686dfef.717a1","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":710,"y":280,"wires":[[]]},{"id":"a1f1dc5b.5575e","type":"change","z":"d686dfef.717a1","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":1620,"y":500,"wires":[["38044fdc.3c623"]]},{"id":"1fe736a7.002129","type":"change","z":"d686dfef.717a1","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":400,"y":280,"wires":[["ff00ae16.65327"]]},{"id":"9cadf24b.8007","type":"change","z":"d686dfef.717a1","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":460,"y":680,"wires":[["e55b3b85.abff48"]]},{"id":"be7c3980.aef798","type":"change","z":"d686dfef.717a1","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":460,"y":720,"wires":[["265a73de.be9f3c"]]},{"id":"1bfc9a0a.cba736","type":"link out","z":"d686dfef.717a1","name":"","links":["549c31fe.97ffc","740b1d9c.97ec34"],"x":415,"y":920,"wires":[]},{"id":"283a4596.b99c4a","type":"delay","z":"d686dfef.717a1","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":320,"y":920,"wires":[["1bfc9a0a.cba736"]]},{"id":"3fee3499.c0672c","type":"change","z":"d686dfef.717a1","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":1000,"y":720,"wires":[["120f0609.5ed48a"]]},{"id":"120f0609.5ed48a","type":"template","z":"d686dfef.717a1","name":"","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` (`sender`, `status`, `content`, `statusTime`, `rxTime`) VALUES ('System', 'Records Deleted','Records Deleted', '{{timestamp}}', '{{timestamp}}');","output":"str","x":1140,"y":720,"wires":[["c32e8dcd.171eb"]]},{"id":"c32e8dcd.171eb","type":"sqlite","z":"d686dfef.717a1","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":1290,"y":720,"wires":[[]]},{"id":"1fa37719.6d09c9","type":"template","z":"d686dfef.717a1","name":"Log Export","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` (`sender`, `status`, `content`, `statusTime`, `rxTime`) VALUES ('System', 'eMail Address Changed','eMail Changed to {{global.to}}', '{{timestamp}}', '{{timestamp}}');","output":"str","x":750,"y":460,"wires":[["f3761d54.3dfc7"]]},{"id":"f3761d54.3dfc7","type":"sqlite","z":"d686dfef.717a1","mydb":"33804e00.060d32","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":910,"y":460,"wires":[["9a7595f4.a65cc8"]]},{"id":"83da1ade.86cc08","type":"change","z":"d686dfef.717a1","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":600,"y":460,"wires":[["1fa37719.6d09c9"]]},{"id":"9a7595f4.a65cc8","type":"link out","z":"d686dfef.717a1","name":"","links":["549c31fe.97ffc","740b1d9c.97ec34"],"x":1015,"y":460,"wires":[]},{"id":"28109660.2cccaa","type":"function","z":"1e3bcfcf.ac722","name":"Split Content into 2","func":"var payload = msg.content;\n\nvar str = \"\" + payload;\nvar split = str.split(\"-\");\n\nmsg.msgPart1 = split[0];\nmsg.msgPart2 = split[1];\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":360,"wires":[["8ef0a0b3.b6d3f"]]},{"id":"4930c76f.cd2a98","type":"function","z":"599bf1f1.c3be9","name":"Set Style","func":"var array = msg.payload\nvar i;\nfor (i = 0; i < array.length; i++) { \n    \n  if (msg.payload[i].status == \"Late\") {\n    msg.payload[i].style = \"flash bold\"\n} else {\n    msg.payload[i].style = \"\"\n}\n}\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":280,"wires":[["68309b06.3cb724"]]},{"id":"dc4fbf9b.e97cf","type":"function","z":"11ba16cf.809619","name":"Set Style","func":"var array = msg.payload\nvar i;\nfor (i = 0; i < array.length; i++) { \n    \n  if (msg.payload[i].status == \"Late\") {\n    msg.payload[i].style = \"flash bold\"\n} else {\n    msg.payload[i].style = \"\"\n}\n}\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":280,"wires":[["ba8cac2.2141f5"]]},{"id":"dceecf04.d8c2d","type":"function","z":"1e3bcfcf.ac722","name":"Set Style","func":"var array = msg.payload\nvar i;\nfor (i = 0; i < array.length; i++) { \n    \n  if (msg.payload[i].status == \"Late\") {\n    msg.payload[i].style = \"flash bold\"\n} else {\n    msg.payload[i].style = \"\"\n}\n}\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":200,"wires":[["84f3ad59.90ac"]]},{"id":"fed8f6a1.06ea58","type":"http response","z":"1e3bcfcf.ac722","name":"","statusCode":"","headers":{},"x":610,"y":100,"wires":[]},{"id":"ea61304f.bb962","type":"http in","z":"1e3bcfcf.ac722","name":"","url":"/display","method":"get","upload":false,"swaggerDoc":"","x":110,"y":100,"wires":[["b556140b.bd87a8"]]},{"id":"90260fa8.a8f2","type":"comment","z":"1e3bcfcf.ac722","name":"Build Webpage","info":"","x":120,"y":20,"wires":[]},{"id":"438c7126.b28d6","type":"template","z":"1e3bcfcf.ac722","name":"HTML","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<!DOCTYPE html>\n<html>\n<head>\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    \n    <title>CaptureCall Dynamic Display</title>\n\n    <script>\n        {{{script}}}\n    </script>\n    \n    <style>\n        {{{global.css}}}\n    </style>\n\n</head>\n\n<body onload=\"startTime()\">\n\n      <div class=\"heading\">\n          \n    <div class=\"left\">\n        \n        <a href=\"/export\" class=\"settings\">Go to Export Menu</a>\n        <BR>\n        <a href=\"/log-daily\" class=\"settings\" >Go to Daily Log</a>    \n        <BR>\n        <a href=\"/log-full\" class=\"settings\" >Go to Full Log</a>\n        </div>\n    <div class=\"middle\">\n        <h1 id=\"title\">CaptureCall Dynamic Display</h1>\n    </div>\n    \n    <div class=\"right\">\n        \n        <div class=\"clock\" id=\"time\"></div>\n    </div>\n    \n    </div>\n\n    <div class=\"wrapper\" id=\"data\">\n\n    \n      \n     \n     \n   \n</div>\n\n</body>\n\n</html>","output":"str","x":490,"y":100,"wires":[["fed8f6a1.06ea58"]]},{"id":"b556140b.bd87a8","type":"template","z":"1e3bcfcf.ac722","name":"CSS","field":"css","fieldType":"global","format":"css","syntax":"mustache","template":"    * {\n      padding: 0px;\n      margin: 0;\n      box-sizing: border-box;\n      background: #456FA0;\n    }\n\n    h1 {\n      padding: 10px;\n      text-align: center;\n    }\n\n    html,\n    body,\n    p {\n      font-family: Arial, Helvetica, sans-serif;\n      font-size: 1vw;\n      margin: 0px;\n      padding-left: 0px;\n      color: white;\n    }\n\n    .wrapper {\n      display: grid;\n    }\n\n    .heading {\n      width: 100%;\n      display: grid;\n      grid-template-columns: 25% 50% 25%;\n      grid-gap: 0em;\n      height: auto;\n      padding: 10px;\n    }\n\n    .left {\n      text-align: left;\n    }\n\n    .middle {\n      text-align: center;\n    }\n\n    .right {\n      text-align: right;\n    }\n    \n    .clock {\n        font-size: 2vw;\n        padding-top:10px;\n        font-weight: bold;\n    }\n\n    .nested {\n      display: grid;\n      justify-content: space-evenly;\n      align-content: center;\n      grid-template-columns: repeat(6, 1.5fr);\n      font-size: 1.5vw;\n      text-align: center;\n      color: black;\n    }\n    \n    .nestedLog {\n      display: grid;\n      justify-content: space-evenly;\n      align-content: center;\n      grid-template-columns: repeat(12, 1fr);\n      font-size: 1vw;\n      text-align: center;\n      color: black;\n    }\n.nested10 {\n      display: grid;\n      justify-content: space-evenly;\n      align-content: center;\n      grid-template-columns: repeat(10, 1fr);\n      font-size: 1vw;\n      text-align: center;\n      color: black;\n    }\n    .wrapper>div {\n      background: #eee;\n      padding: 0.5em;\n    }\n\n    .wrapper>div:nth-child(odd) {\n      background: #ddd;\n    }\n\n    .nested>div {\n      padding: 0.5em;\n      background-color: inherit;\n    }\n    \n    .nestedLog>div {\n      padding: 0.5em;\n      background-color: inherit;\n    }\n    .nested10>div {\n      padding: 0.5em;\n      background-color: inherit;\n    }\n    .bold {\n    font-weight: bold;    \n    }\n\n    .flash {\n        color: red;\n    }\n    \n    .red {\n    color: red;\n    }\n\n    a:link {\n      text-decoration: none;\n      color: white;\n    }\n\n    a:visited {\n      text-decoration: none;\n      color: white;\n    }\n\n    a:hover {\n      color: red;\n    }\n    \n#notes {\n    font-size: 1.5vw;\n}\n       .grid-container {\n            display: grid;\n            grid-template-columns: auto;\n            padding: 0px;\n        }\n\n        .grid-item {\n            padding: 20px;\n            font-size: 48px;\n            text-align: center;\n        }\n        \n.name {\n            box-sizing: border-box;\n            width: 50%;\n            border-radius: 10px;\n            font-weight: normal;\n            font-size: 1vw;\n            font-family: Arial, Helvetica, sans-serif;\n            text-align: center;\n            padding: 10px;\n            margin: 0px;\n            text-overflow: ellipsis;\n            box-shadow: 10px 10px 20px black;\n            background-color: lightgrey;\n }\n","output":"str","x":250,"y":100,"wires":[["f8f08692.d9fae8"]]},{"id":"f8f08692.d9fae8","type":"template","z":"1e3bcfcf.ac722","name":"Script","field":"script","fieldType":"msg","format":"javascript","syntax":"plain","template":"    var receive = new WebSocket('ws://' + location.host + '/ws/receive');\n    var send = new WebSocket('ws://' + location.host + '/ws/send');\n        var msg = 0; // Make Incoming WS Global\n\n        // Log messages from the server\n        receive.onmessage = function(d) {\n            var txt = d.data;\n            msg = JSON.parse(txt);\n            console.log(msg);\n            document.getElementById(\"data\").innerHTML = msg.payload;\n    \n        };\n        \n\nfunction startTime() {\n    var today = new Date();\n    var h = today.getHours();\n    var m = today.getMinutes();\n    var s = today.getSeconds();\n    m = checkTime(m);\n    s = checkTime(s);\n    document.getElementById('time').innerHTML =\n    h + \":\" + m + \":\" + s;\n    var t = setTimeout(startTime, 500);\n} //Clock\n\nfunction checkTime(i) {\n    if (i < 10) {i = \"0\" + i}  // add zero in front of numbers < 10\n    return i;\n}\n     ","output":"str","x":370,"y":100,"wires":[["438c7126.b28d6"]]},{"id":"c5d9308.62745d","type":"http response","z":"9728e5d5.763308","name":"","statusCode":"","headers":{},"x":1050,"y":200,"wires":[]},{"id":"c299255d.7f0b28","type":"http in","z":"9728e5d5.763308","name":"","url":"/index","method":"get","upload":false,"swaggerDoc":"","x":380,"y":240,"wires":[["efd299f0.ea4de8"]]},{"id":"6808a9a1.af3928","type":"comment","z":"9728e5d5.763308","name":"Build Webpage","info":"","x":400,"y":120,"wires":[]},{"id":"df711175.cbfcb","type":"template","z":"9728e5d5.763308","name":"HTML","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<!DOCTYPE html>\n<html>\n<head>\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    \n    <title>{{title}}</title>\n\n    <script>\n        {{{script}}}\n    </script>\n    \n    <style>\n        {{{global.css}}}\n    </style>\n\n</head>\n\n<body onload=\"startTime()\">\n\n<div class=\"heading\">\n          \n    <div class=\"left\" id=\"left\"></div>\n    <div class=\"middle\" id=\"middle\"></div>\n    <div class=\"right\" id=\"right\"></div>\n</div>\n\n    <div class=\"wrapper\" id=\"data\"></div>\n\n</body>\n\n</html>","output":"str","x":930,"y":200,"wires":[["c5d9308.62745d"]]},{"id":"19e04a45.178696","type":"template","z":"9728e5d5.763308","name":"CSS","field":"css","fieldType":"global","format":"css","syntax":"mustache","template":"    * {\n      padding: 0px;\n      margin: 0;\n      box-sizing: border-box;\n      background: #456FA0;\n    }\n\n    h1 {\n      padding: 10px;\n      text-align: center;\n    }\n\n    html,\n    body,\n    p {\n      font-family: Arial, Helvetica, sans-serif;\n      font-size: 1vw;\n      margin: 0px;\n      padding-left: 0px;\n      color: white;\n    }\n\n    .wrapper {\n      display: grid;\n    }\n\n    .heading {\n      width: 100%;\n      display: grid;\n      grid-template-columns: 25% 50% 25%;\n      grid-gap: 0em;\n      height: auto;\n      padding: 10px;\n    }\n\n    .left {\n      text-align: left;\n    }\n\n    .middle {\n      text-align: center;\n    }\n\n    .right {\n      text-align: right;\n    }\n    \n    .clock {\n        font-size: 2vw;\n        padding-top:10px;\n        font-weight: bold;\n    }\n\n    .nested {\n      display: grid;\n      justify-content: space-evenly;\n      align-content: center;\n      grid-template-columns: repeat(6, 1.5fr);\n      font-size: 1.5vw;\n      text-align: center;\n      color: black;\n    }\n    \n    .nestedLog {\n      display: grid;\n      justify-content: space-evenly;\n      align-content: center;\n      grid-template-columns: repeat(12, 1fr);\n      font-size: 1vw;\n      text-align: center;\n      color: black;\n    }\n.nested10 {\n      display: grid;\n      justify-content: space-evenly;\n      align-content: center;\n      grid-template-columns: repeat(10, 1fr);\n      font-size: 1vw;\n      text-align: center;\n      color: black;\n    }\n    .wrapper>div {\n      background: #eee;\n      padding: 0.5em;\n    }\n\n    .wrapper>div:nth-child(odd) {\n      background: #ddd;\n    }\n\n    .nested>div {\n      padding: 0.5em;\n      background-color: inherit;\n    }\n    \n    .nestedLog>div {\n      padding: 0.5em;\n      background-color: inherit;\n    }\n    .nested10>div {\n      padding: 0.5em;\n      background-color: inherit;\n    }\n    .bold {\n    font-weight: bold;    \n    }\n\n    .flash {\n        color: red;\n    }\n    \n    .red {\n    color: red;\n    }\n\n    a:link {\n      text-decoration: none;\n      color: white;\n    }\n\n    a:visited {\n      text-decoration: none;\n      color: white;\n    }\n\n    a:hover {\n      color: red;\n    }\n    \n#notes {\n    font-size: 1.5vw;\n}\n       .grid-container {\n            display: grid;\n            grid-template-columns: auto;\n            padding: 0px;\n        }\n\n        .grid-item {\n            padding: 20px;\n            font-size: 48px;\n            text-align: center;\n        }\n        \n.name {\n            box-sizing: border-box;\n            width: 50%;\n            border-radius: 10px;\n            font-weight: normal;\n            font-size: 1vw;\n            font-family: Arial, Helvetica, sans-serif;\n            text-align: center;\n            padding: 10px;\n            margin: 0px;\n            text-overflow: ellipsis;\n            box-shadow: 10px 10px 20px black;\n            background-color: lightgrey;\n }\n","output":"str","x":690,"y":200,"wires":[["bd4d1f0b.b7c7a"]]},{"id":"bd4d1f0b.b7c7a","type":"template","z":"9728e5d5.763308","name":"Script","field":"script","fieldType":"msg","format":"javascript","syntax":"plain","template":"    var data = new WebSocket('ws://' + location.host + '/ws/data');\n    var left = new WebSocket('ws://' + location.host + '/ws/left');\n    var middle = new WebSocket('ws://' + location.host + '/ws/middle');\n    var right = new WebSocket('ws://' + location.host + '/ws/right');\n    var send = new WebSocket('ws://' + location.host + '/ws/send');\n    \n     var data = 0; // Make Data WS Global\n     var left = 0; // Make Left WS Global\n     var middle = 0; // Make middle WS Global\n     var right = 0; // Make Right WS Global\n\n        // Log messages from the server\n        data.onmessage = function(d) {\n            var txt = d.data;\n            data = JSON.parse(txt);\n            console.log(data);\n            document.getElementById(\"data\").innerHTML = data.payload;\n    };\n    \n        // Log messages from the server\n        left.onmessage = function(d) {\n            var txt = d.data;\n            left = JSON.parse(txt);\n            console.log(left);\n            document.getElementById(\"left\").innerHTML = left.payload;\n    };\n    \n        // Log messages from the server\n        middle.onmessage = function(d) {\n            var txt = d.data;\n            middle = JSON.parse(txt);\n            console.log(middle);\n            document.getElementById(\"middle\").innerHTML = middle.payload;\n    };\n    \n        // Log messages from the server\n        right.onmessage = function(d) {\n            var txt = d.data;\n            right = JSON.parse(txt);\n            console.log(right);\n            document.getElementById(\"right\").innerHTML = right.payload;\n    };\n        \n\nfunction startTime() {\n    var today = new Date();\n    var h = today.getHours();\n    var m = today.getMinutes();\n    var s = today.getSeconds();\n    m = checkTime(m);\n    s = checkTime(s);\n    document.getElementById('clock').innerHTML =\n    h + \":\" + m + \":\" + s;\n    var t = setTimeout(startTime, 500);\n} //Clock\n\nfunction checkTime(i) {\n    if (i < 10) {i = \"0\" + i}  // add zero in front of numbers < 10\n    return i;\n}\n     ","output":"str","x":810,"y":200,"wires":[["df711175.cbfcb"]]},{"id":"338dc9ef.b35cc6","type":"http in","z":"9728e5d5.763308","name":"","url":"/","method":"get","upload":false,"swaggerDoc":"","x":390,"y":160,"wires":[["efd299f0.ea4de8"]]},{"id":"efd299f0.ea4de8","type":"change","z":"9728e5d5.763308","name":"Set Page Title","rules":[{"t":"set","p":"title","pt":"msg","to":"Test Page","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":540,"y":200,"wires":[["19e04a45.178696"]]},{"id":"65edbfb4.2be6","type":"link in","z":"9728e5d5.763308","name":"Referesh Webpage","links":[],"x":415,"y":200,"wires":[["efd299f0.ea4de8"]]},{"id":"bd67bdda.bf37","type":"template","z":"9728e5d5.763308","name":"HTML","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<!DOCTYPE html>\n<html>\n<head>\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    \n    <title>{{title}}</title>\n\n    <script>\n        {{{script}}}\n    </script>\n    \n    <style>\n        {{{global.css}}}\n    </style>\n\n</head>\n\n<body onload=\"startTime()\">\n\n      <div class=\"heading\">\n          \n    <div class=\"left\" id=\"left\"></div>\n    <div class=\"middle\"><h1 id=\"title\">{{title}}</h1></div>\n    \n    <div class=\"right\" id=\"right\">\n        \n    <div class=\"clock\" id=\"clock\"></div>\n    \n    </div>\n    \n    </div>\n\n    <div class=\"wrapper\" id=\"data\">\n\n    \n      \n          \n        <a href=\"/export\" class=\"settings\">Go to Export Menu</a>\n        <BR>\n        <a href=\"/log-daily\" class=\"settings\" >Go to Daily Log</a>    \n        <BR>\n        <a href=\"/log-full\" class=\"settings\" >Go to Full Log</a>\n     \n   \n</div>\n\n</body>\n\n</html>","output":"str","x":930,"y":100,"wires":[[]]}]